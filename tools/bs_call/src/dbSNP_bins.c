/*
 * dbSNP_bins.c
 *
 *  Created on: Feb 3, 2020
 *      Author: heath
 */

#include "dbSNP_idx.h"
#include "dbSNP_utils.h"
#include <sys/types.h>
#include <sys/wait.h>
#include <zlib.h>

#include <htslib/khash.h>

KHASH_SET_INIT_STR(str);

void clear_bins(bin *b, int ct) {
	for(int i = 0; i < ct; i++) {
		b[i].entry_size = 0;
		b[i].entry = NULL;
		b[i].name_buf_size = b[i].name_buf_idx = 0;
		b[i].name_buf = NULL;
		b[i].mask = 0;
		b[i].fq_mask = 0;
		b[i].n_entries = 0;
	}
}

static char dtab[256] =
{
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0x0, 0x1, 0x2, 0x3, 0x4, 0x5, 0x6, 0x7, 0x8, 0x9, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf,
		0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf
};

void check_prefix(prefix **ppt, char *pref, int len, dbsnp_param_t * const par) {
	prefix *p = *ppt;
	if(!p || strlen(p->pref) != len || memcmp(p->pref, pref, len)) {
		pthread_mutex_lock(&par->param_mut);
		HASH_FIND(hh, par->prefixes, pref, len, p);
		if(!p) {
			if(par->n_prefix == 0xffff) {
				fprintf(stderr, "Too many SNP prefixes found (%d)\n", par->n_prefix);
				exit(-1);
			}
			p = malloc(sizeof(prefix));
			p->ix = par->n_prefix++;
			p->pref = malloc((size_t)(len + 1));
			memcpy(p->pref, pref, len);
			p->pref[len] = 0;
			HASH_ADD_KEYPTR(hh, par->prefixes, p->pref, len, p);
			fprintf(stderr,"Added new prefix %d, '%s'\n", p->ix, p->pref);
		}
		*ppt = p;
		pthread_mutex_unlock(&par->param_mut);
	}
}

int add_to_bin(bin * const b, const snp_t * const snp, const int pref_ix, dbsnp_param_t * const par) {
	const uint8_t off = snp->pos & 63;
	uint64_t msk = (uint64_t)1 << off;
	if(b->mask & msk) return 0;
	b->mask |= msk;
	if(!b->entry_size) {
		b->entry_size = INITIAL_ENTRY_SIZE;
		b->entry = malloc(sizeof(uint16_t) * INITIAL_ENTRY_SIZE * 2);
		b->name_buf_size = INITIAL_NAME_BUF_SIZE;
		b->name_buf = malloc((size_t)INITIAL_NAME_BUF_SIZE);
	}
	if(b->n_entries == b->entry_size) {
		b->entry_size *= 1.5;
		if(b->entry_size > 64) b->entry_size = 64;
		b->entry = realloc(b->entry, sizeof(uint16_t) * b->entry_size * 2);
	}
	if(snp->name_len > 510) {
		fprintf(stderr,"%s:%d %s() Marker name exceeds 510 characters: %s\n", __FILE__, __LINE__, __func__, snp->name);
		exit(-1);
	}
	uint16_t l1 = (uint16_t)(snp->name_len - snp->name_off + 1) >> 1;
	uint16_t sz = b->name_buf_idx;
	if(sz + l1 > b->name_buf_size) {
		b->name_buf_size = (b->name_buf_size + l1) * 1.25;
		b->name_buf = realloc(b->name_buf, (size_t)b->name_buf_size);
	}
	const char c = snp->name[snp->name_len];
	snp->name[snp->name_len] = 0;
	bool select = snp->maf >= par->maf_limit;
	if(!select && par->select_hash) {
		khash_t(str) *h = par->select_hash;
		khint_t k = kh_get(str, h, snp->name);
		if(k != kh_end(h)) select = true;
	}
	if(select) b->fq_mask |= ((uint64_t)1 << b->n_entries);
	int x = (b->n_entries++) << 1;
	b->entry[x] = (l1 << 8) | off;
	b->entry[x + 1] = pref_ix;
	for(size_t i = snp->name_off; i < snp->name_len; i += 2) {
		b->name_buf[b->name_buf_idx++] = (dtab[(int)snp->name[i]] << 4) | dtab[(int)snp->name[i + 1]];
	}
	snp->name[snp->name_len] = c;
	return 1;
}


